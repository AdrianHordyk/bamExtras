#' Estimate age and length at 5% and full (100%) vulnerability (total selectivity) and retention (landings selectivity)
#'
#' @param Vdata Vulnerability-at-age vector (total selectivity of landings and discards)
#' @param retdata Retention-at-age vector (combined selectivity for landings)
#' @param Linf Von Bertalanffy growth parameter length infinity
#' @param K Von Bertalanffy growth parameter K
#' @param t0 Von Bertalanffy growth parameter theoretical age at age zero
#' @param length_sc Scalar (multiplier) to convert length units. MSEtool examples seem to use cm whereas BAM uses mm.
#' @keywords bam stock assessment fisheries DLMtool
#' @author Nikolai Klibansky
#' @export
#' @examples
#' \dontrun{
#'
#' }
vulnerability <- function(Vdata,retdata=NULL, Linf,K,t0,length_sc=1){
  # Vulnerability

  Vdata <- Vdata/max(Vdata) # Scaled as a proportion of maximum vulnerability

  age <- as.numeric(names(Vdata))
  Vage <- Vdata

  age_pr <- seq(min(age),max(age),length=1000)
  V_pr <- approx(age,Vage,xout = age_pr)$y

  ageV_05 <- age_pr[which.min(abs(V_pr-0.05))] # age at 5% vulnerability
  ageV_100 <- age_pr[which.min(abs(V_pr-1.00))] # age at 100% vulnerability

  lenage <- vb_len(Linf=Linf, K=K, t0=t0, a=age)*length_sc
  len_pr <- vb_len(Linf=Linf, K=K, t0=t0, a=age_pr)*length_sc

  lenV_05 <- vb_len(Linf=Linf, K=K, t0=t0, a=ageV_05)*length_sc # Length at 5% vulnerability
  lenV_100 <- vb_len(Linf=Linf, K=K, t0=t0, a=ageV_100)*length_sc # Length at 100% vulnerability

  # Retention
  if(is.null(retdata)){
    lenret_05 <-  lenV_05
    lenret_100 <- lenV_100
  }else{
    retdata <- retdata/max(retdata) # Scaled as a proportion of maximum retention

    age <- as.numeric(names(retdata))
    retage <- retdata

    age_pr <- seq(min(age),max(age),length=1000)
    ret_pr <- approx(age,retage,xout = age_pr)$y

    ageret_05 <- age_pr[which.min(abs(ret_pr-0.05))] # age at 5% landings selectivity
    ageret_100 <- age_pr[which.min(abs(ret_pr-1.00))] # age at 100% landings selectivity

    lenage <- vb_len(Linf=Linf, K=K, t0=t0, a=age)*length_sc
    len_pr <- vb_len(Linf=Linf, K=K, t0=t0, a=age_pr)*length_sc

    lenret_05 <- vb_len(Linf=Linf, K=K, t0=t0, a=ageret_05)*length_sc # Length at 5% landings selectivity
    lenret_100 <- vb_len(Linf=Linf, K=K, t0=t0, a=ageret_100)*length_sc # Length at 100% landings selectivity
  }
  return(list("L5"=lenV_05,"LFS"=lenV_100,"LR5"=lenret_05,"LFR"=lenret_100,
              "A5"=ageV_05,"AFS"=ageV_100,"AR5"=ageret_05,"AFR"=ageret_100))
}
